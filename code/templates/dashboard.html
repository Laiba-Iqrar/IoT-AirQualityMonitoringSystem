<!DOCTYPE html>
<html>
<head>
    <title>CO₂ Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <meta http-equiv="refresh" content="60">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">{{ channel_name }} - CO₂ Monitoring Dashboard</span>
        </div>
    </nav>

    <div class="container">
        <!-- Latest Values -->
        <div class="mb-4">
            <h2 class="text-primary">Latest Sensor Readings</h2>
            <div class="row">
                {% for field_name in fields %}
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-info h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ field_name }}</h5>
                            <p class="card-text display-6">{{ latest_entry.fields[field_name] | default('N/A') }}</p>
                        </div>
                        <div class="card-footer text-white-50">
                            {{ latest_entry.timestamp | datetimeformat }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Live Gauges -->
        <!-- <div class="mb-5">
            <h2 class="text-success">Live Environmental Gauges</h2>
            <div class="row text-center">
                <div class="col-md-6">
                    <h5>CO₂ Level (ppm)</h5>
                    <canvas id="co2Gauge" width="200" height="200"></canvas>
                </div>
                <div class="col-md-6">
                    <h5>Temperature (°C)</h5>
                    <canvas id="temperatureThermometer" width="200" height="200"></canvas>
                </div>
            </div>
        </div> -->
        <!-- Live Gauges -->
        <div class="mb-5">
            <h2 class="text-success">Live Environmental Gauges</h2>
            <div class="row text-center">
                <div class="col-md-4">
                    <h5>CO₂ Level (ppm)</h5>
                    <canvas id="co2Gauge" width="200" height="200"></canvas>
                </div>
                <div class="col-md-4">
                    <h5>Temperature (°C)</h5>
                    <canvas id="temperatureThermometer" width="200" height="200"></canvas>
                </div>
                <div class="col-md-4">
                    <h5>Humidity (%)</h5>
                    <canvas id="humidityGauge" width="200" height="200"></canvas>
                </div>
            </div>
        </div>




        <!-- Chart Section -->
        <div class="mb-5">
            <h2 class="text-warning">Historical Data Chart</h2>
            <canvas id="dataChart" height="120"></canvas>
        </div>
    </div>

    <script>
        const labels = [{% for entry in all_data %}"{{ entry.timestamp | datetimeformat }}",{% endfor %}];
        const datasets = [
            {% for field_name in fields %}
            {
                label: '{{ field_name }}',
                data: [
                    {% for entry in all_data %}
                        {{ entry.fields[field_name] | float if entry.fields[field_name] else 'null' }},
                    {% endfor %}
                ],
                borderColor: `hsl({{ loop.index * 110 }}, 70%, 50%)`,
                backgroundColor: `hsla({{ loop.index * 110 }}, 70%, 50%, 0.2)`,
                tension: 0.3,
                fill: false,
                spanGaps: true
            },
            {% endfor %}
        ];

        new Chart(document.getElementById('dataChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Sensor Data Over Time' }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm:ss' },
                        title: { display: true, text: 'Timestamp' }
                    },
                    y: {
                        title: { display: true, text: 'Values' },
                        beginAtZero: false
                    }
                }
            }
        });

        function createGauge(id, value, min, max, label) {
            new Chart(document.getElementById(id).getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: [label, 'Remaining'],
                    datasets: [{
                        label: label,
                        data: [value, max - value],
                        backgroundColor: ['#007bff', '#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    rotation: -90,
                    circumference: 180,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        title: { display: true, text: `${value} ${label}` }
                    }
                }
            });
        }

        // Replace with real-time values passed from Flask if desired
        createGauge('co2Gauge', {{ latest_entry.fields['CO2'] | default(0) | float }}, 0, 2000, 'ppm');
        createGauge('temperatureThermometer', {{ latest_entry.fields['Temperature'] | default(0) | float }}, -10, 50, '°C');
        createGauge('humidityGauge', {{ latest_entry.fields['Humidity'] | default(0) | float }}, 0, 100, '%');

    </script>
</body>
</html>
